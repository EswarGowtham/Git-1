<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        form {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }

        label {
            width: 100px;
            text-align: right;
            margin-right: 10px;
        }

        input {
            width: 150px;
        }

        button {
            margin-left: 10px;
        }

        #error-message {
            color: red;
        }

        #result {
            margin-top: 20px;
        }
    </style>
    <script>
        function updateQuantity(value, detailId) {
            var quantitySpan = document.getElementById(`displayed-quantity-${detailId}`);
            var quantity = parseInt(quantitySpan.innerText, 10);
            var updatedQuantity = quantity - value;

            if (updatedQuantity < 0) {
                document.getElementById('error-message').innerText = 'Error: Quantity cannot be less than 0.';
                return;
            }

            quantitySpan.innerText = updatedQuantity;
            document.getElementById('error-message').innerText = '';
            var storedDetails = localStorage.getItem('productDetails');
            
            if (storedDetails) {
                var allDetails = JSON.parse(storedDetails);
                for (var i = 0; i < allDetails.length; i++) { 
                    if (allDetails[i].name === detailId) {
                        allDetails[i].quantity = updatedQuantity;
                        var detailsToUpdate = {
                            _id: allDetails[i]._id, 
                            name: allDetails[i].name,
                          
                            quantity: updatedQuantity
                        };
                        saveDetailsToCrud(detailsToUpdate);
                        break
                        break;
                    }
                }
                localStorage.setItem('productDetails', JSON.stringify(allDetails));
            }
        }
        function validateQuantity() {
            var quantity = parseInt(document.getElementById('quantity').value, 10);

            if (quantity < 0) {
                document.getElementById('error-message').innerText = 'Error: Quantity cannot be less than 0.';
                return false;
            } else {
                document.getElementById('error-message').innerText = '';
                return true;
            }
        }
        function saveDetails(details) {
            var storedDetails = localStorage.getItem('productDetails');

            var allDetails = [];
            if (storedDetails) {
                allDetails = JSON.parse(storedDetails);
            }
            // Add the new details to the list
            var new_detail = {
                name: details.name,
                description: details.description,
                price: details.price,
                quantity: details.quantity
            };
            allDetails.push(new_detail);

            // Save the updated details list in localStorage
            localStorage.setItem('productDetails', JSON.stringify(allDetails));
        }

        function loadDetails() {
            // Load existing details from localStorage
            var storedDetails = localStorage.getItem('productDetails');
            try {
                var allDetails = JSON.parse(storedDetails);
                if (Array.isArray(allDetails)) {
                    allDetails.forEach(displayDetails);
                } else if (typeof allDetails === 'object' && allDetails !== null) {
                    // Convert object to array and display details
                    var detailsArray = Object.values(allDetails);
                    detailsArray.forEach(displayDetails);
                } else {
                    console.error('Unexpected data type in localStorage:', typeof allDetails);
                }
            } catch (error) {
                console.error('Error parsing stored details:', error);
            }
        }
        function handleSubmit(event) {
            event.preventDefault(); // Prevent the default form submission behavior
            if (validateQuantity()) {
                var name = document.getElementById('name').value;
                var description = document.getElementById('description').value;
                var price = document.getElementById('price').value;
                var quantity = document.getElementById('quantity').value;
        
                var details = {
                    name: name,
                    description: description,
                    price: price,
                    quantity: quantity
                };
        
                // Display and save the new details
                displayDetails(details);
                saveDetails(details);
                saveDetailsToCrud(details);
            }
            return false; // Ensure the form does not actually submit
        }
        function saveDetailsToCrud(details) {
            var apiEndpoint = 'https://crudcrud.com/api/50f04c8f62b341ce84f3f2aacad9f61c/New_data';
            fetch(apiEndpoint, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(existingData => {
                const existingDetail = existingData.find(item => item.name === details.name);
                if (existingDetail) {
                    // Data already exists, perform a PUT request to update it
                    return fetch(`${apiEndpoint}/${existingDetail._id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(details),
                    });
                } else {
                    // Data doesn't exist, perform a POST request to create it
                    return fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(details),
                    });
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Data saved to CRUD:', data);
            })
            .catch(error => {
                console.error('Error saving data to CRUD:', error);
            });
        }
        
        function displayDetails(details) {
            var resultDiv = document.getElementById('result');
            var detailId = details.name.replace(/\s+/g, '-'); // Generate a unique ID

            resultDiv.innerHTML += `<div id="${detailId}">
                                       <p><strong>Name:</strong> ${details.name} | 
                                       <strong>Description:</strong> ${details.description} | 
                                       <strong>Price:</strong> ${details.price} | 
                                       <strong>Quantity:</strong> <span id="displayed-quantity-${detailId}">${details.quantity}</span> |
                                       <button type="button" onclick="updateQuantity(1, '${detailId}')">Buy 1</button>
                                       <button type="button" onclick="updateQuantity(2, '${detailId}')">Buy 2</button>
                                       <button type="button" onclick="updateQuantity(3, '${detailId}')">Buy 3</button>
                                       <button type="button" onclick="deleteDetails('${detailId}')">Delete</button></p>
                                   </div>`;
        }
        function deleteDetails(detailId) {
            var detailElement = document.getElementById(detailId);
            var storedDetails = localStorage.getItem('productDetails');
            
            if (detailElement && storedDetails) {
                var allDetails = JSON.parse(storedDetails);
        
                for (var i = 0; i < allDetails.length; i++) { 
                    if (allDetails[i].name === detailId) {
                        allDetails.splice(i, 1); 
                        break;
                    }
                }
        
                detailElement.remove();
                localStorage.setItem('productDetails', JSON.stringify(allDetails));
                var apiEndpoint = 'https://crudcrud.com/api/50f04c8f62b341ce84f3f2aacad9f61c/New_data';
                fetch(`${apiEndpoint}/${detailId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => {
                    if (response.ok) {
                        console.log('Data deleted from CRUD API');
                    } else {
                        console.error('Failed to delete data from CRUD API');
                    }
                })
                .catch(error => {
                    console.error('Error deleting data from CRUD API:', error);
                });
                
            }
        }   

        window.onload = loadDetails;

    </script>
    <title>Product Form</title>
</head>
<body>

    <h1>Product Information</h1>

    <form onsubmit="return handleSubmit(event);">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>

        <label for="description">Description:</label>
        <input type="text" id="description" name="description" required>

        <label for="price">Price:</label>
        <input type="text" id="price" name="price" required>

        <label for="quantity">Quantity:</label>
        <input type="number" id="quantity" name="quantity" min="0" required>

        <button type="submit">Submit</button>
    </form>

    <p id="error-message"></p>

    <div id="result">

        <h2>Details</h2>

    </div>

</body>
</html>
